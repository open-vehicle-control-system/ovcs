From 59f0d61699350a6df661c838a502a566b1c02768 Mon Sep 17 00:00:00 2001
From: Frank Hunleth <fhunleth@troodon-software.com>
Date: Tue, 5 May 2020 21:19:01 -0400
Subject: [PATCH] disksup: update df call to work with Busybox

Busybox's df doesn't support `-x` and `-l` and this removes those
options. Plus SquashFS filesystems are nice to view on Nerves so we
don't want to exclude them anyway.
---
 lib/os_mon/src/disksup.erl | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/lib/os_mon/src/disksup.erl b/lib/os_mon/src/disksup.erl
index 8df01f9eb9..06333ce83c 100644
--- a/lib/os_mon/src/disksup.erl
+++ b/lib/os_mon/src/disksup.erl
@@ -1,8 +1,8 @@
 %%
 %% %CopyrightBegin%
-%% 
+%%
 %% Copyright Ericsson AB 1996-2022. All Rights Reserved.
-%% 
+%%
 %% Licensed under the Apache License, Version 2.0 (the "License");
 %% you may not use this file except in compliance with the License.
 %% You may obtain a copy of the License at
@@ -14,7 +14,7 @@
 %% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 %% See the License for the specific language governing permissions and
 %% limitations under the License.
-%% 
+%%
 %% %CopyrightEnd%
 %%
 -module(disksup).
@@ -115,7 +115,7 @@ param_default(disksup_posix_only) -> false.
 %% gen_server callbacks
 %%----------------------------------------------------------------------
 
-init([]) ->  
+init([]) ->
     process_flag(trap_exit, true),
     process_flag(priority, low),
 
@@ -239,7 +239,7 @@ get_os(PosixOnly) ->
 
 %%--Port handling functions---------------------------------------------
 
-start_portprogram() -> 
+start_portprogram() ->
     open_port({spawn, "sh -s disksup 2>&1"}, [stream]).
 
 my_cmd(Cmd0, Port) ->
@@ -250,8 +250,8 @@ my_cmd(Cmd0, Port) ->
     get_reply(Port, []).
 
 get_reply(Port, O) ->
-    receive 
-        {Port, {data, N}} -> 
+    receive
+        {Port, {data, N}} ->
             case newline(N, O) of
                 {ok, Str} -> Str;
                 {more, Acc} -> get_reply(Port, Acc)
@@ -287,7 +287,7 @@ run_df(Path, {unix, irix}, Port) ->
     my_cmd("/usr/sbin/df -lk " ++ Path, Port);
 run_df(Path, {unix, linux}, Port) ->
     Df = find_cmd("df", "/bin"),
-    my_cmd(Df ++ " -lk -x squashfs " ++ Path, Port);
+    my_cmd(Df ++ " -k" ++ Path, Port);
 run_df(Path, {unix, posix}, Port) ->
     my_cmd("df -k -P " ++ Path, Port);
 run_df(Path, {unix, dragonfly}, Port) ->
-- 
2.34.1

